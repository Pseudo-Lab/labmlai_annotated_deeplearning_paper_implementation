<!DOCTYPE html>
<html lang="ko">

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Compressive Transformer의 설명과 구현에 대한 문서입니다." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image:src" content="https://avatars1.githubusercontent.com/u/64068543?s=400&amp;v=4" />
    <meta name="twitter:title" content="Compressive Transformer" />
    <meta name="twitter:description" content="Compressive Transformer의 설명과 구현에 대한 문서입니다." />
    <meta name="twitter:site" content="@labmlai" />
    <meta name="twitter:creator" content="@labmlai" />

    <meta property="og:url" content="https://nn.labml.ai/transformers/compressive/index.html" />
    <meta property="og:title" content="Compressive Transformer" />
    <meta property="og:image" content="https://avatars1.githubusercontent.com/u/64068543?s=400&amp;v=4" />
    <meta property="og:site_name" content="Compressive Transformer" />
    <meta property="og:type" content="object" />
    <meta property="og:title" content="Compressive Transformer" />
    <meta property="og:description"
        content="Documented implementation with explanations of a Compressive Transformer model." />

    <title>Compressive Transformer</title>
    <link rel="shortcut icon" href="/icon.png" />
    <link rel="stylesheet" href="../../pylit.css?v=1">
    <link rel="canonical" href="https://nn.labml.ai/transformers/compressive/index.html" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
        integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4V3HC8HBLH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-4V3HC8HBLH');
    </script>
</head>

<body>
    <div id='container'>
        <div id="background"></div>
        <div class='section'>
            <div class='docs'>
                <p>
                    <a class="parent" href="/">home</a>
                    <a class="parent" href="../index.html">transformers</a>
                    <a class="parent" href="index.html">compressive</a>
                </p>
                <p>
                    <a href="https://github.com/labmlai/annotated_deep_learning_paper_implementations" target="_blank">
                        <img alt="Github"
                            src="https://img.shields.io/github/stars/labmlai/annotated_deep_learning_paper_implementations?style=social"
                            style="max-width:100%;" /></a>
                    <a href="https://twitter.com/labmlai" rel="nofollow" target="_blank">
                        <img alt="Twitter" src="https://img.shields.io/twitter/follow/labmlai?style=social"
                            style="max-width:100%;" /></a>
                </p>
                <p>
                    <a href="https://github.com/labmlai/annotated_deep_learning_paper_implementations/tree/master/labml_nn/transformers/compressive/__init__.py"
                        target="_blank">
                        View code on Github</a>
                </p>
            </div>
        </div>
        <div class='section' id='section-0'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-0'>#</a>
                </div>
                <h1>Compressive Transformer</h1>
                <p><a href="https://papers.labml.ai/paper/1911.05507">Compressive
                        Transformers for Long-Range Sequence Modelling</a>를 <a href="https://pytorch.org">PyTorch</a>로
                    구현한 내용에 대한 문서입니다.
                </p>
                <p>과거의 압축하여 더 긴 어텐션 범위를 제공하는 <a href="../xl/index.html">Transformer XL</a>의 확장입니다. 즉, 가장 먼
                    <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span
                                        class="mord coloredeq eqi" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="">n</span><span class="msupsub"><span
                                                    class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eqk"
                                                                                style="">c</span></span><span
                                                                            class="mord mathnormal mtight"
                                                                            style="">m</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span><span
                                        class="mord coloredeq eqk" style=""><span class="mord mathnormal"
                                            style="">c</span></span></span></span></span></span>의 기억은 <span><span
                            class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span
                                        class="mord coloredeq eqi" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="">n</span><span class="msupsub"><span
                                                    class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eqk"
                                                                                style="">c</span></span><span
                                                                            class="mord mathnormal mtight"
                                                                            style="">m</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>
                    메모리로 압축되며, 여기서 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.43056em;vertical-align:0em;"></span><span
                                        class="mord coloredeq eqk" style=""><span class="mord mathnormal"
                                            style="">c</span></span></span></span></span></span>는 압축률입니다.
                </p>
                <h2>압축 작업</h2>
                <p>압축 작업은 다음과 같이 정의됩니다. <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span><span
                                        class="mspace" style="margin-right:0.2777777777777778em;"></span><span
                                        class="mrel">:</span><span class="mspace"
                                        style="margin-right:0.2777777777777778em;"></span></span><span
                                    class="base"><span class="strut"
                                        style="height:0.8491079999999999em;vertical-align:0em;"></span><span
                                        class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span
                                                class="vlist-t"><span class="vlist-r"><span class="vlist"
                                                        style="height:0.8491079999999999em;"><span
                                                            style="top:-3.063em;margin-right:0.05em;"><span
                                                                class="pstrut" style="height:2.7em;"></span><span
                                                                class="sizing reset-size6 size3 mtight"><span
                                                                    class="mord mtight"><span
                                                                        class="mord mathnormal mtight">n</span><span
                                                                        class="mord mtight coloredeq eqk" style=""><span
                                                                            class="mord mathnormal mtight"
                                                                            style="">c</span></span><span
                                                                        class="mbin mtight">×</span><span
                                                                        class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span
                                        class="mspace" style="margin-right:0.2777777777777778em;"></span><span
                                        class="mrel">→</span><span class="mspace"
                                        style="margin-right:0.2777777777777778em;"></span></span><span
                                    class="base"><span class="strut"
                                        style="height:0.8491079999999999em;vertical-align:0em;"></span><span
                                        class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span
                                                class="vlist-t"><span class="vlist-r"><span class="vlist"
                                                        style="height:0.8491079999999999em;"><span
                                                            style="top:-3.063em;margin-right:0.05em;"><span
                                                                class="pstrut" style="height:2.7em;"></span><span
                                                                class="sizing reset-size6 size3 mtight"><span
                                                                    class="mord mtight"><span
                                                                        class="mord mathnormal mtight">n</span><span
                                                                        class="mbin mtight">×</span><span
                                                                        class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span>.
                    이 논문에서는 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>
                    에 대한 여러 선택지를 소개하며, 저희는 가장 좋은 결과를 제공하는 것으로 보이는 1D 컨볼루션만 구현하였습니다. 각 레이어는 별도의 압축 연산<span><span
                            class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:1.16678em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqe" style=""><span class="mord" style=""><span
                                                class="mord" style=""><span class="mord coloredeq eqj" style=""><span
                                                        class="mord mathnormal"
                                                        style="margin-right:0.10764em">f</span><span
                                                        class="msupsub"><span class="vlist-t vlist-t2"><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.151392em;"><span
                                                                        style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                            class="pstrut"
                                                                            style="height:2.7em;"></span><span
                                                                            class="sizing reset-size6 size3 mtight"
                                                                            style=""><span class="mord mtight"
                                                                                style=""><span
                                                                                    class="mord mathnormal mtight coloredeq eqk"
                                                                                    style="">c</span></span></span></span></span><span
                                                                    class="vlist-s">​</span></span><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.15em;"><span></span></span></span></span></span></span></span><span
                                                class="msupsub"><span class="vlist-t"><span class="vlist-r"><span
                                                            class="vlist" style="height:0.97234em;"><span
                                                                style="top:-3.14734em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mopen mtight" style="">(</span><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eql"
                                                                                style="">i</span></span><span
                                                                            class="mclose mtight"
                                                                            style="">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span>
                    를 갖고 있으며, <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.65952em;vertical-align:0em;"></span><span
                                        class="mord coloredeq eql" style=""><span class="mord mathnormal"
                                            style="">i</span></span></span></span></span></span> 는 각 레이어의 번호입니다.
                </p>
                <h2>압축 작업 훈련</h2>
                <p>BPTT를 사용한 훈련 압축은 매우 큰 계산 그래프(많은 타임 스텝)를 유지해야 하므로, 이 논문에서는 <em>자동 인코딩 손실</em>과 <em>어텐션 재구성 손실</em>을
                    제안합니다. 자동 인코딩 손실은 압축된
                    메모리에서 원본 메모리를 디코딩하여 손실을 계산합니다. 어텐션 재구성 손실은 압축된 메모리와 압축되지 않은 메모리에 대한 멀티 헤드 어텐션 결과를 계산하고 그 사이의 평균 제곱
                    오차를
                    구합니다. 여기서는 후자가 더 나은 결과를 제공하기 때문에 후자를 구현했습니다.</p>
                <p>이 구현은 사전 레이어 정규화를 사용하는 반면 논문은 사후 레이어 정규화를 사용합니다. 사전 레이어 정규화는 <a href="../feedforward.html">FFN</a> 및
                    셀프 어텐션 전에 레이어 정규화를 수행하며, residual
                    connection의 pass-through는
                    정규화되지 않습니다. 이러한 방법은 표준 트랜스포머에서 더 안정적일 것입니다.</p>
                <p>다음은 Tiny Shakespeare 데이터 세트에서 압축 변환기 모델을 학습하기 위한 <a href="experiment.html">학습 코드</a>와 노트북입니다.</p>
                <p><a
                        href="https://colab.research.google.com/github/labmlai/annotated_deep_learning_paper_implementations/blob/master/labml_nn/transformers/compressive/experiment.ipynb"><img
                            alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"></a></p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">53</span><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="lineno">54</span>
<span class="lineno">55</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="lineno">56</span><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="lineno">57</span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="lineno">58</span>
<span class="lineno">59</span><span class="kn">from</span> <span class="nn">labml_helpers.module</span> <span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">TypedModuleList</span>
<span class="lineno">60</span><span class="kn">from</span> <span class="nn">labml_nn.transformers.feed_forward</span> <span class="kn">import</span> <span class="n">FeedForward</span>
<span class="lineno">61</span><span class="kn">from</span> <span class="nn">labml_nn.transformers.mha</span> <span class="kn">import</span> <span class="n">PrepareForMultiHeadAttention</span>
<span class="lineno">62</span><span class="kn">from</span> <span class="nn">labml_nn.transformers.xl.relative_mha</span> <span class="kn">import</span> <span class="n">RelativeMultiHeadAttention</span>
<span class="lineno">63</span><span class="kn">from</span> <span class="nn">labml_nn.utils</span> <span class="kn">import</span> <span class="n">clone_module_list</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-1'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-1'>#</a>
                </div>
                <h2>1D 컨볼루션 압축 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>
                </h2>
                <p>텐서 차원 순열이 포함된 <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv1d.html"><code
                            class="highlight"><span></span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span></code>
                    </a>의 간단한 래퍼입니다.</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">66</span><span class="k">class</span> <span class="nc">Conv1dCompression</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-2'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-2'>#</a>
                </div>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">compression_rate</span></code>는 압축률
                        <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                            class="strut" style="height:0.43056em;vertical-align:0em;"></span><span
                                            class="mord coloredeq eqk" style=""><span class="mord mathnormal"
                                                style="">c</span></span></span></span></span></span>입니다.
                    </li>
                    <li><code class="highlight"><span></span><span class="n">d_model</span></code>
                        는 임베딩 크기입니다.</li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">74</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compression_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-3'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-3'>#</a>
                </div>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">79</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="lineno">80</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">compression_rate</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">compression_rate</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-4'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-4'>#</a>
                </div>
                <p> <code class="highlight"><span></span><span class="n">mem</span></code>은 <code
                        class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>의
                    형태입니다.
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">82</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-5'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-5'>#</a>
                </div>
                <p>컨볼루션 레이어를 통과할 수 있도록 <code class="highlight"><span></span><span class="n">mem</span></code>의 차원을
                    변환합니다. 컨볼루션 레이어는 <code
                        class="highlight"><span></span><span class="p">[</span><span class="n">batch</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">sequence</span><span class="p">]</span></code>
                    형식을 갖고 있습니다.
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">89</span>        <span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-6'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-6'>#</a>
                </div>
                <p>컨볼루션 레이어를 통과시켜 압축된 메모리를 가져옵니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">91</span>        <span class="n">c_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-7'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-7'>#</a>
                </div>
                <p>Permute back to form <code
                        class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">93</span>        <span class="k">return</span> <span class="n">c_mem</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-8'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-8'>#</a>
                </div>
                <h2>Compressive Transformer 레이어</h2>
                <p>compressive transformer 레이어 하나의 구현에 관한 내용입니다.</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">96</span><span class="k">class</span> <span class="nc">CompressiveTransformerLayer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-9'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-9'>#</a>
                </div>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">d_model</span></code>
                        토큰 임베딩의 사이즈입니다 </li>
                    <li><code class="highlight"><span></span><span class="n">self_attn</span></code>
                        is the <a href="../xl/relative_mha.html">은 셀프 어텐션 모듈</a>입니다 </li>
                    <li><code class="highlight"><span></span><span class="n">feed_forward</span></code>
                        은 <a href="../feed_forward.html">피드 포워드 모듈</a>입니다 </li>
                    <li><code class="highlight"><span></span><span class="n">dropout_prob</span></code>
                        은 셀프 어텐션과 FFN을 거친 후, 드롭아웃을 거칠 가능성입니다 </li>
                    <li><code class="highlight"><span></span><span class="n">compress</span></code>
                        은 압축 함수 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                        class="base"><span class="strut"
                                            style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                            class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                    class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                    class="msupsub"><span class="vlist-t vlist-t2"><span
                                                            class="vlist-r"><span class="vlist"
                                                                style="height:0.151392em;"><span
                                                                    style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                        class="pstrut"
                                                                        style="height:2.7em;"></span><span
                                                                        class="sizing reset-size6 size3 mtight"
                                                                        style=""><span class="mord mtight"
                                                                            style=""><span
                                                                                class="mord mathnormal mtight coloredeq eqk"
                                                                                style="">c</span></span></span></span></span><span
                                                                class="vlist-s">​</span></span><span
                                                            class="vlist-r"><span class="vlist"
                                                                style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>입니다
                    </li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">102</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<span class="lineno">103</span>                 <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="lineno">104</span>                 <span class="n">self_attn</span><span class="p">:</span> <span class="n">RelativeMultiHeadAttention</span><span class="p">,</span>
<span class="lineno">105</span>                 <span class="n">feed_forward</span><span class="p">:</span> <span class="n">FeedForward</span><span class="p">,</span>
<span class="lineno">106</span>                 <span class="n">dropout_prob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="lineno">107</span>                 <span class="n">compress</span><span class="p">:</span> <span class="n">Conv1dCompression</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-10'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-10'>#</a>
                </div>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">115</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="lineno">116</span>        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
<span class="lineno">117</span>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">d_model</span>
<span class="lineno">118</span>        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">self_attn</span>
<span class="lineno">119</span>        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span> <span class="o">=</span> <span class="n">feed_forward</span>
<span class="lineno">120</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_prob</span><span class="p">)</span>
<span class="lineno">121</span>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_self_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">([</span><span class="n">d_model</span><span class="p">])</span>
<span class="lineno">122</span>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_ff</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">([</span><span class="n">d_model</span><span class="p">])</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-11'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-11'>#</a>
                </div>
                <p> 정규화된 토큰 임베딩을 메모리 및 압축 메모리와 연결합니다.</p>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">z</span></code>
                        는 레이어 정규화된 토큰 임베딩입니다. </li>
                    <li><code class="highlight"><span></span><span class="n">mem</span></code>
                        은 <code class="highlight"><span></span><span class="n">c_mem</span></code>
                        은 메모리 및 압축 메모리입니다. (정규화를 거치지 않은 것에 주의하세요)</li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">124</span>    <span class="k">def</span> <span class="nf">concat_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">c_mem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-12'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-12'>#</a>
                </div>
                <p>메모리가 없다면, 토큰 임베딩을 반환합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">133</span>        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="lineno">134</span>            <span class="k">return</span> <span class="n">z</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-13'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-13'>#</a>
                </div>
                <p>압축된 메모리가 있는 경우 이를 메모리와 연결합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">137</span>        <span class="k">if</span> <span class="n">c_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="lineno">138</span>            <span class="n">mem</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">c_mem</span><span class="p">,</span> <span class="n">mem</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-14'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-14'>#</a>
                </div>
                <p>정규화 레이어에 메모리를 통과시킵니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">141</span>        <span class="n">mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_self_attn</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-15'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-15'>#</a>
                </div>
                <p>정규화된 메모리와 정규화된 토큰 임베딩 연결하기 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">143</span>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">mem</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-16'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-16'>#</a>
                </div>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">x</span></code>
                        는 토큰 레벨 특징 벡터의 텐서입니다. <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                    </li>
                    <li><code class="highlight"><span></span><span class="n">mem</span></code>
                        은 과거의 토큰 레벨 특징 벡터(메모리)의 텐서입니다. <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">mem_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                    </li>
                    <li><code class="highlight"><span></span><span class="n">c_mem</span></code>
                        은 압축된 메모리의 텐서입니다 <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">c_mem_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                    </li>
                    <li><code class="highlight"><span></span><span class="n">mask</span></code>
                        는 <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">c_mem_len</span> <span class="o">+</span> <span class="n">mem_len</span> <span class="o">+</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">]</span></code>
                        또는 <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">c_mem_len</span> <span class="o">+</span> <span class="n">mem_len</span> <span class="o">+</span> <span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></code>
                        모양의 행렬입니다. <code
                            class="highlight"><span></span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span></code>
                        는 <code class="highlight"><span></span><span class="n">i</span></code>
                        의 토큰이 <code class="highlight"><span></span><span class="n">j</span></code>
                        의 토큰을 볼 수 있으면 참입니다.</li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">145</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<span class="lineno">146</span>                <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="lineno">147</span>                <span class="n">mem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<span class="lineno">148</span>                <span class="n">c_mem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<span class="lineno">149</span>                <span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-17'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-17'>#</a>
                </div>
                <p>셀프 어텐션 전에 벡터를 정규화해줍니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">159</span>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_self_attn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-18'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-18'>#</a>
                </div>
                <p>메모리와 압축 메모리를 정규화하고 연결합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">161</span>        <span class="n">m_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_memory</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">c_mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-19'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-19'>#</a>
                </div>
                <p>어텐션 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">163</span>        <span class="n">self_attn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">m_z</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">m_z</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-20'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-20'>#</a>
                </div>
                <p>어텐션 결과를 더해줍니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">165</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">self_attn</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-21'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-21'>#</a>
                </div>
                <p>피드 포워드를 위한 정규화 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">168</span>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_ff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-22'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-22'>#</a>
                </div>
                <p>피드 포워드 네트워크를 통과시켜줍니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">170</span>        <span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-23'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-23'>#</a>
                </div>
                <p>피드 포워드 결과를 다시 추가합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">172</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-24'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-24'>#</a>
                </div>
                <p> </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">175</span>        <span class="k">return</span> <span class="n">x</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-25'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-25'>#</a>
                </div>
                <h2>Compressive Transformer 모델</h2>
                <p>여러 개의 compressive transformer 레이어로 구성되어 있습니다.</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">178</span><span class="k">class</span> <span class="nc">CompressiveTransformer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-26'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-26'>#</a>
                </div>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">185</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">CompressiveTransformerLayer</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="lineno">186</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-27'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-27'>#</a>
                </div>
                <p>트랜스포머 레이어의 복사본을 만듭니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">188</span>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">clone_module_list</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-28'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-28'>#</a>
                </div>
                <p>마지막 정규화 레이어 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">190</span>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">([</span><span class="n">layer</span><span class="o">.</span><span class="n">size</span><span class="p">])</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-29'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-29'>#</a>
                </div>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">x</span></code>
                        는 토큰 임베딩 벡터의 텐서입니다. <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                    </li>
                    <li><code class="highlight"><span></span><span class="n">mem</span></code>
                        은 과거 토큰 레벨 특징 벡터의 텐서 리스트입니다. <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">mem_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                        의 모양을 갖고 있습니다. </li>
                    <li><code class="highlight"><span></span><span class="n">c_mem</span></code>
                        is a list of tensors of the compressed memory <code
                            class="highlight"><span></span><span class="p">[</span><span class="n">c_mem_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                        은 압축된 메모리의 텐서 목록입니다. </li>
                    <li><code class="highlight"><span></span><span class="n">mask</span></code>
                        는 마스킹 매트릭스입니다.</li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">192</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">c_mem</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-30'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-30'>#</a>
                </div>
                <p>다음 순차 배치의 메모리가 될 토큰 레벨 특성 벡터를 저장하는 목록입니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">203</span>        <span class="n">new_mem</span> <span class="o">=</span> <span class="p">[]</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-31'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-31'>#</a>
                </div>
                <p>각 트랜스포머 레이어를 통과시킵니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">205</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-32'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-32'>#</a>
                </div>
                <p>특성 벡터의 목록에 추가합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">207</span>            <span class="n">new_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-33'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-33'>#</a>
                </div>
                <p>메모리 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">209</span>            <span class="n">m</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">mem</span> <span class="k">else</span> <span class="kc">None</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-34'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-34'>#</a>
                </div>
                <p>압축된 메모리 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">211</span>            <span class="n">cm</span> <span class="o">=</span> <span class="n">c_mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">c_mem</span> <span class="k">else</span> <span class="kc">None</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-35'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-35'>#</a>
                </div>
                <p>XL 트랜스포머 레이어에 통과시킵니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">213</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">c_mem</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-36'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-36'>#</a>
                </div>
                <p>마지막으로, 벡터를 정규화합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">215</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">new_mem</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-37'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-37'>#</a>
                </div>
                <h2>어텐션 재구성 손실</h2>
                <p>어텐션 재구성 손실은 압축되지 않은 메모리와 압축된 메모리로 셀프 어텐션 출력을 재현하고 둘 사이의 평균 제곱 오차를 계산합니다. 위치 인코딩 없이 이 작업을 수행합니다.</p>
                <p>어텐션 재구성 손실로 압축 함수 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>를
                    계산하고 훈련할 때 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>를
                    제외한 모든 파라미터가 동결됩니다. 여기에는 정규화 후 키/밸류 투영 및 편향/스케일링이 포함됩니다.</p>
                <p>이 손실은 모델의 크로스 엔트로피 손실과 독립적으로 계산할 수 있으므로 <span><span class="katex"><span aria-hidden="true"
                                class="katex-html"><span class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>만
                    업데이트하는 별도의 옵티마이저를 가질 수 있습니다.
                    그러나 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>
                    업데이트를 위해 동일한 옵티마이저를 사용하여 어텐션 재구성 손실을 계산할 때 <span><span class="katex"><span aria-hidden="true"
                                class="katex-html"><span class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqj" style=""><span class="mord" style=""><span
                                                class="mord mathnormal" style="margin-right:0.10764em">f</span><span
                                                class="msupsub"><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.151392em;"><span
                                                                style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight coloredeq eqk"
                                                                            style="">c</span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>를
                    제외한 다른 모든 매개 변수를 그래디언트 계산에서 분리합니다.</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">218</span><span class="k">class</span> <span class="nc">AttentionReconstructionLoss</span><span class="p">:</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-38'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-38'>#</a>
                </div>
                <p> <code class="highlight"><span></span><span class="n">layers</span></code>
                    는 Compressive Transformer 레이어들의 리스트입니다</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">236</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">TypedModuleList</span><span class="p">[</span><span class="n">CompressiveTransformerLayer</span><span class="p">]):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-39'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-39'>#</a>
                </div>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">240</span>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
<span class="lineno">241</span>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-40'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-40'>#</a>
                </div>
                <p> 이것은 <a href="../mha.html#PrepareMHA">&#x27;PrepareForMultiHeadAttention&#x27;</a>을 재구현한 것으로, 그래디언트
                    계산에서 분리된 매개 변수로 투영을 합니다. </p>
                <ul>
                    <li><code class="highlight"><span></span><span class="n">pmha</span></code>
                        는 <a href="../mha.html#PrepareMHA">&#x27;PrepareForMultiHeadAttention&#x27;</a> 모듈입니다
                    </li>
                    <li><code class="highlight"><span></span><span class="n">x</span></code>
                        는 토큰 임베딩 텐서입니다</li>
                </ul>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">243</span>    <span class="k">def</span> <span class="nf">prepare_for_attn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmha</span><span class="p">:</span> <span class="n">PrepareForMultiHeadAttention</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-41'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-41'>#</a>
                </div>
                <p>임베딩 차원을 제외한 텐서의 모양; <code
                        class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">]</span></code>
                    . </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">253</span>        <span class="n">head_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-42'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-42'>#</a>
                </div>
                <p>투영 가중치와 편향을 분리합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">256</span>        <span class="n">weight</span> <span class="o">=</span> <span class="n">pmha</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="lineno">257</span>        <span class="n">bias</span> <span class="o">=</span> <span class="n">pmha</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">if</span> <span class="n">pmha</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-43'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-43'>#</a>
                </div>
                <p>선형 변환 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">259</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-44'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-44'>#</a>
                </div>
                <p>마지막 차원을 헤드로 분할합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">262</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">head_shape</span><span class="p">,</span> <span class="n">pmha</span><span class="o">.</span><span class="n">heads</span><span class="p">,</span> <span class="n">pmha</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-45'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-45'>#</a>
                </div>
                <p>출력은 </p> <code
                    class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">d_k</span><span class="p">]</span></code>
                또는 <code
                    class="highlight"><span></span><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">]</span></code>
                의 모양을 갖고 있습니다
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">265</span>        <span class="k">return</span> <span class="n">x</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-46'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-46'>#</a>
                </div>
                <p> 프로젝션 매개변수를 분리하기 위해 <a href="../mha.html#PrepareMHA">&#x27;PrepareForMultiHeadAttention&#x27;</a> 대신
                    <code class="highlight"><span></span><span class="n">prepare_for_attn</span></code>을 호출하는
                    <a href="../mha.html#MHA">&#x27;Multi-Head Attention&#x27;</a>을 재구현한 것입니다.
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">267</span>    <span class="k">def</span> <span class="nf">attn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">RelativeMultiHeadAttention</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-47'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-47'>#</a>
                </div>
                <p>쿼리, 키, 밸류의 투영을 계산합니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">274</span>        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_attn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
<span class="lineno">275</span>        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_attn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="lineno">276</span>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_attn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-48'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-48'>#</a>
                </div>
                <p> <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:1.043548em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqf" style=""><span class="mord mathnormal"
                                            style="">Q</span><span class="mord" style=""><span class="mord mathnormal"
                                                style="margin-right:0.07153em">K</span><span class="msupsub"><span
                                                    class="vlist-t"><span class="vlist-r"><span class="vlist"
                                                            style="height:0.849108em;"><span
                                                                style="top:-3.063em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight"
                                                                        style="">⊤</span></span></span></span></span></span></span></span></span></span></span></span></span>
                    의 어텐션 점수를 계산합니다. <code
                        class="highlight"><span></span><span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">heads</span><span class="p">]</span></code>
                    의 모양을 갖고 있습니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">280</span>        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ibhd,jbhd-&gt;ijbh&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-49'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-49'>#</a>
                </div>
                <p>점수를 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:1.633028em;vertical-align:-0.538em;"></span><span
                                        class="mord coloredeq eqd" style=""><span class="mord" style=""><span
                                                class="mopen nulldelimiter"></span><span class="mfrac"><span
                                                    class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"
                                                            style="height:1.095028em;"><span
                                                                style="top:-2.5864385em;"><span class="pstrut"
                                                                    style="height:3em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord sqrt mtight" style=""><span
                                                                                class="vlist-t vlist-t2"><span
                                                                                    class="vlist-r"><span class="vlist"
                                                                                        style="height:0.8622307142857143em;"><span
                                                                                            class="svg-align"
                                                                                            style="top:-3em;"><span
                                                                                                class="pstrut"
                                                                                                style="height:3em;"></span><span
                                                                                                class="mord mtight"
                                                                                                style="padding-left:0.833em"><span
                                                                                                    class="mord mtight"
                                                                                                    style=""><span
                                                                                                        class="mord mathnormal mtight"
                                                                                                        style="">d</span><span
                                                                                                        class="msupsub"><span
                                                                                                            class="vlist-t vlist-t2"><span
                                                                                                                class="vlist-r"><span
                                                                                                                    class="vlist"
                                                                                                                    style="height:0.3448em;"><span
                                                                                                                        style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span
                                                                                                                            class="pstrut"
                                                                                                                            style="height:2.5em;"></span><span
                                                                                                                            class="sizing reset-size3 size1 mtight"
                                                                                                                            style=""><span
                                                                                                                                class="mord mathnormal mtight"
                                                                                                                                style="margin-right:0.03148em">k</span></span></span></span><span
                                                                                                                    class="vlist-s">​</span></span><span
                                                                                                                class="vlist-r"><span
                                                                                                                    class="vlist"
                                                                                                                    style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span
                                                                                            style="top:-2.8222307142857144em;"><span
                                                                                                class="pstrut"
                                                                                                style="height:3em;"></span><span
                                                                                                class="hide-tail mtight"
                                                                                                style="min-width:0.853em;height:1.08em"><svg
                                                                                                    height="1.08em"
                                                                                                    preserveaspectratio="xMinYMin slice"
                                                                                                    viewbox="0 0 400000 1080"
                                                                                                    width="400em"
                                                                                                    xmlns="http://www.w3.org/2000/svg">
                                                                                                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                                                                </svg></span></span></span><span
                                                                                        class="vlist-s">​</span></span><span
                                                                                    class="vlist-r"><span class="vlist"
                                                                                        style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span
                                                                style="top:-3.23em;"><span class="pstrut"
                                                                    style="height:3em;"></span><span class="frac-line"
                                                                    style="border-bottom-width:0.04em"></span></span><span
                                                                style="top:-3.446108em;"><span class="pstrut"
                                                                    style="height:3em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eqf"
                                                                                style="">Q</span><span
                                                                                class="mord mtight coloredeq eqf"
                                                                                style=""><span
                                                                                    class="mord mathnormal mtight"
                                                                                    style="margin-right:0.07153em">K</span><span
                                                                                    class="msupsub"><span
                                                                                        class="vlist-t"><span
                                                                                            class="vlist-r"><span
                                                                                                class="vlist"
                                                                                                style="height:0.9270285714285713em;"><span
                                                                                                    style="top:-2.931em;margin-right:0.07142857142857144em;"><span
                                                                                                        class="pstrut"
                                                                                                        style="height:2.5em;"></span><span
                                                                                                        class="sizing reset-size3 size1 mtight"
                                                                                                        style=""><span
                                                                                                            class="mord mtight"
                                                                                                            style="">⊤</span></span></span></span></span></span></span></span></span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:0.538em;"><span></span></span></span></span></span><span
                                                class="mclose nulldelimiter"></span></span></span></span></span></span></span>로
                    스케일링합니다
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">283</span>        <span class="n">scores</span> <span class="o">*=</span> <span class="n">layer</span><span class="o">.</span><span class="n">scale</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-50'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-50'>#</a>
                </div>
                <p>키 시퀀스 차원을 따라<span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqh" style=""><span class="mord mathnormal"
                                            style="">so</span><span class="mord mathnormal"
                                            style="margin-right:0.10764em">f</span><span class="mord mathnormal"
                                            style="">t</span><span class="mord mathnormal" style="">ma</span><span
                                            class="mord mathnormal" style="">x</span></span></span></span></span></span>
                    어텐션 합니다 <span><span class="katex"><span aria-hidden="true" class="katex-html"><span
                                    class="base"><span class="strut"
                                        style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span
                                        class="mord coloredeq eqc" style=""><span class="mord" style=""><span
                                                class="mop op-limits" style=""><span class="vlist-t vlist-t2"><span
                                                        class="vlist-r"><span class="vlist"
                                                            style="height:0.6944399999999998em;"><span
                                                                style="top:-2.20556em;margin-left:0em;"><span
                                                                    class="pstrut" style="height:3em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mord mathnormal mtight"
                                                                            style="">se</span><span
                                                                            class="mord mathnormal mtight"
                                                                            style="margin-right:0.03588em">q</span></span></span></span><span
                                                                style="top:-3em;"><span class="pstrut"
                                                                    style="height:3em;"></span><span><span class="mop"
                                                                        style=""><span class="mord" style=""><span
                                                                                class="mord mathnormal coloredeq eqh"
                                                                                style="">so</span><span
                                                                                class="mord mathnormal coloredeq eqh"
                                                                                style="margin-right:0.10764em">f</span><span
                                                                                class="mord mathnormal coloredeq eqh"
                                                                                style="">t</span><span
                                                                                class="mord mathnormal coloredeq eqh"
                                                                                style="">ma</span><span
                                                                                class="mord mathnormal coloredeq eqh"
                                                                                style="">x</span></span></span></span></span></span><span
                                                            class="vlist-s">​</span></span><span class="vlist-r"><span
                                                            class="vlist"
                                                            style="height:1.030548em;"><span></span></span></span></span></span></span><span
                                            class="mord" style=""><span class="delimsizing size4" style=""><span
                                                    style="">(</span></span></span><span class="mord" style=""><span
                                                class="mord coloredeq eqd" style=""><span
                                                    class="mopen nulldelimiter"></span><span class="mfrac"><span
                                                        class="vlist-t vlist-t2"><span class="vlist-r"><span
                                                                class="vlist" style="height:1.095028em;"><span
                                                                    style="top:-2.5864385em;"><span class="pstrut"
                                                                        style="height:3em;"></span><span
                                                                        class="sizing reset-size6 size3 mtight"
                                                                        style=""><span class="mord mtight"
                                                                            style=""><span class="mord sqrt mtight"
                                                                                style=""><span
                                                                                    class="vlist-t vlist-t2"><span
                                                                                        class="vlist-r"><span
                                                                                            class="vlist"
                                                                                            style="height:0.8622307142857143em;"><span
                                                                                                class="svg-align"
                                                                                                style="top:-3em;"><span
                                                                                                    class="pstrut"
                                                                                                    style="height:3em;"></span><span
                                                                                                    class="mord mtight"
                                                                                                    style="padding-left:0.833em"><span
                                                                                                        class="mord mtight"
                                                                                                        style=""><span
                                                                                                            class="mord mathnormal mtight"
                                                                                                            style="">d</span><span
                                                                                                            class="msupsub"><span
                                                                                                                class="vlist-t vlist-t2"><span
                                                                                                                    class="vlist-r"><span
                                                                                                                        class="vlist"
                                                                                                                        style="height:0.3448em;"><span
                                                                                                                            style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span
                                                                                                                                class="pstrut"
                                                                                                                                style="height:2.5em;"></span><span
                                                                                                                                class="sizing reset-size3 size1 mtight"
                                                                                                                                style=""><span
                                                                                                                                    class="mord mathnormal mtight"
                                                                                                                                    style="margin-right:0.03148em">k</span></span></span></span><span
                                                                                                                        class="vlist-s">​</span></span><span
                                                                                                                    class="vlist-r"><span
                                                                                                                        class="vlist"
                                                                                                                        style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span
                                                                                                style="top:-2.8222307142857144em;"><span
                                                                                                    class="pstrut"
                                                                                                    style="height:3em;"></span><span
                                                                                                    class="hide-tail mtight"
                                                                                                    style="min-width:0.853em;height:1.08em"><svg
                                                                                                        height="1.08em"
                                                                                                        preserveaspectratio="xMinYMin slice"
                                                                                                        viewbox="0 0 400000 1080"
                                                                                                        width="400em"
                                                                                                        xmlns="http://www.w3.org/2000/svg">
                                                                                                        <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                                                                    </svg></span></span></span><span
                                                                                            class="vlist-s">​</span></span><span
                                                                                        class="vlist-r"><span
                                                                                            class="vlist"
                                                                                            style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span
                                                                    style="top:-3.23em;"><span class="pstrut"
                                                                        style="height:3em;"></span><span
                                                                        class="frac-line"
                                                                        style="border-bottom-width:0.04em"></span></span><span
                                                                    style="top:-3.446108em;"><span class="pstrut"
                                                                        style="height:3em;"></span><span
                                                                        class="sizing reset-size6 size3 mtight"
                                                                        style=""><span class="mord mtight"
                                                                            style=""><span class="mord mtight"
                                                                                style=""><span
                                                                                    class="mord mathnormal mtight coloredeq eqf"
                                                                                    style="">Q</span><span
                                                                                    class="mord mtight coloredeq eqf"
                                                                                    style=""><span
                                                                                        class="mord mathnormal mtight"
                                                                                        style="margin-right:0.07153em">K</span><span
                                                                                        class="msupsub"><span
                                                                                            class="vlist-t"><span
                                                                                                class="vlist-r"><span
                                                                                                    class="vlist"
                                                                                                    style="height:0.9270285714285713em;"><span
                                                                                                        style="top:-2.931em;margin-right:0.07142857142857144em;"><span
                                                                                                            class="pstrut"
                                                                                                            style="height:2.5em;"></span><span
                                                                                                            class="sizing reset-size3 size1 mtight"
                                                                                                            style=""><span
                                                                                                                class="mord mtight"
                                                                                                                style="">⊤</span></span></span></span></span></span></span></span></span></span></span></span></span><span
                                                                class="vlist-s">​</span></span><span
                                                            class="vlist-r"><span class="vlist"
                                                                style="height:0.538em;"><span></span></span></span></span></span><span
                                                    class="mclose nulldelimiter"></span></span></span><span class="mord"
                                            style=""><span class="delimsizing size4" style=""><span
                                                    style="">)</span></span></span></span></span></span></span></span>
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">287</span>        <span class="n">attn</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-51'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-51'>#</a>
                </div>
                <p>밸류를 곱해줍니다 <span><span class="katex-display"><span class="katex"><span aria-hidden="true"
                                    class="katex-html"><span class="base"><span class="strut"
                                            style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span
                                            class="mord coloredeq eqc" style=""><span class="mord" style=""><span
                                                    class="mop op-limits" style=""><span class="vlist-t vlist-t2"><span
                                                            class="vlist-r"><span class="vlist"
                                                                style="height:0.6944399999999998em;"><span
                                                                    style="top:-2.20556em;margin-left:0em;"><span
                                                                        class="pstrut" style="height:3em;"></span><span
                                                                        class="sizing reset-size6 size3 mtight"
                                                                        style=""><span class="mord mtight"
                                                                            style=""><span
                                                                                class="mord mathnormal mtight"
                                                                                style="">se</span><span
                                                                                class="mord mathnormal mtight"
                                                                                style="margin-right:0.03588em">q</span></span></span></span><span
                                                                    style="top:-3em;"><span class="pstrut"
                                                                        style="height:3em;"></span><span><span
                                                                            class="mop" style=""><span class="mord"
                                                                                style=""><span
                                                                                    class="mord mathnormal coloredeq eqh"
                                                                                    style="">so</span><span
                                                                                    class="mord mathnormal coloredeq eqh"
                                                                                    style="margin-right:0.10764em">f</span><span
                                                                                    class="mord mathnormal coloredeq eqh"
                                                                                    style="">t</span><span
                                                                                    class="mord mathnormal coloredeq eqh"
                                                                                    style="">ma</span><span
                                                                                    class="mord mathnormal coloredeq eqh"
                                                                                    style="">x</span></span></span></span></span></span><span
                                                                class="vlist-s">​</span></span><span
                                                            class="vlist-r"><span class="vlist"
                                                                style="height:1.030548em;"><span></span></span></span></span></span></span><span
                                                class="mord" style=""><span class="delimsizing size4" style=""><span
                                                        style="">(</span></span></span><span class="mord" style=""><span
                                                    class="mord coloredeq eqd" style=""><span
                                                        class="mopen nulldelimiter"></span><span class="mfrac"><span
                                                            class="vlist-t vlist-t2"><span class="vlist-r"><span
                                                                    class="vlist"
                                                                    style="height:1.5261079999999998em;"><span
                                                                        style="top:-2.25278em;"><span class="pstrut"
                                                                            style="height:3em;"></span><span
                                                                            class="mord" style=""><span
                                                                                class="mord sqrt" style=""><span
                                                                                    class="vlist-t vlist-t2"><span
                                                                                        class="vlist-r"><span
                                                                                            class="vlist"
                                                                                            style="height:0.85722em;"><span
                                                                                                class="svg-align"
                                                                                                style="top:-3em;"><span
                                                                                                    class="pstrut"
                                                                                                    style="height:3em;"></span><span
                                                                                                    class="mord"
                                                                                                    style="padding-left:0.833em"><span
                                                                                                        class="mord"
                                                                                                        style=""><span
                                                                                                            class="mord mathnormal"
                                                                                                            style="">d</span><span
                                                                                                            class="msupsub"><span
                                                                                                                class="vlist-t vlist-t2"><span
                                                                                                                    class="vlist-r"><span
                                                                                                                        class="vlist"
                                                                                                                        style="height:0.33610799999999996em;"><span
                                                                                                                            style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span
                                                                                                                                class="pstrut"
                                                                                                                                style="height:2.7em;"></span><span
                                                                                                                                class="sizing reset-size6 size3 mtight"
                                                                                                                                style=""><span
                                                                                                                                    class="mord mathnormal mtight"
                                                                                                                                    style="margin-right:0.03148em">k</span></span></span></span><span
                                                                                                                        class="vlist-s">​</span></span><span
                                                                                                                    class="vlist-r"><span
                                                                                                                        class="vlist"
                                                                                                                        style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span
                                                                                                style="top:-2.81722em;"><span
                                                                                                    class="pstrut"
                                                                                                    style="height:3em;"></span><span
                                                                                                    class="hide-tail"
                                                                                                    style="min-width:0.853em;height:1.08em"><svg
                                                                                                        height="1.08em"
                                                                                                        preserveaspectratio="xMinYMin slice"
                                                                                                        viewbox="0 0 400000 1080"
                                                                                                        width="400em"
                                                                                                        xmlns="http://www.w3.org/2000/svg">
                                                                                                        <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path>
                                                                                                    </svg></span></span></span><span
                                                                                            class="vlist-s">​</span></span><span
                                                                                        class="vlist-r"><span
                                                                                            class="vlist"
                                                                                            style="height:0.18278000000000005em;"><span></span></span></span></span></span></span></span><span
                                                                        style="top:-3.23em;"><span class="pstrut"
                                                                            style="height:3em;"></span><span
                                                                            class="frac-line"
                                                                            style="border-bottom-width:0.04em"></span></span><span
                                                                        style="top:-3.677em;"><span class="pstrut"
                                                                            style="height:3em;"></span><span
                                                                            class="mord" style=""><span class="mord"
                                                                                style=""><span
                                                                                    class="mord mathnormal coloredeq eqf"
                                                                                    style="">Q</span><span
                                                                                    class="mord coloredeq eqf"
                                                                                    style=""><span
                                                                                        class="mord mathnormal"
                                                                                        style="margin-right:0.07153em">K</span><span
                                                                                        class="msupsub"><span
                                                                                            class="vlist-t"><span
                                                                                                class="vlist-r"><span
                                                                                                    class="vlist"
                                                                                                    style="height:0.849108em;"><span
                                                                                                        style="top:-3.063em;margin-right:0.05em;"><span
                                                                                                            class="pstrut"
                                                                                                            style="height:2.7em;"></span><span
                                                                                                            class="sizing reset-size6 size3 mtight"
                                                                                                            style=""><span
                                                                                                                class="mord mtight"
                                                                                                                style="">⊤</span></span></span></span></span></span></span></span></span></span></span></span><span
                                                                    class="vlist-s">​</span></span><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.93em;"><span></span></span></span></span></span><span
                                                        class="mclose nulldelimiter"></span></span></span><span
                                                class="mord" style=""><span class="delimsizing size4" style=""><span
                                                        style="">)</span></span></span></span><span
                                            class="mord mathnormal"
                                            style="margin-right:0.22222em;">V</span></span></span></span></span></span>
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">291</span>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijbh,jbhd-&gt;ibhd&quot;</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-52'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-52'>#</a>
                </div>
                <p> 매개변수를 분리한 상태에서 시프트 및 스케일링과 레이어 정규화를 수행합니다.</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">293</span>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-53'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-53'>#</a>
                </div>
                <p>시프트(<code class="highlight"><span></span><span class="n">bias</span></code>
                    ) 와 스케일링(<code class="highlight"><span></span><span class="n">weight</span></code>
                    ) 파라미터를 분리합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">299</span>        <span class="n">weight</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="lineno">300</span>        <span class="n">bias</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-54'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-54'>#</a>
                </div>
                <p>레이어 정규화 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">303</span>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">layer_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ln</span><span class="o">.</span><span class="n">normalized_shape</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">ln</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-55'>
            <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-55'>#</a>
                </div>
                <p> 한 레이어의 손실을 계산합니다</p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">305</span>    <span class="k">def</span> <span class="nf">calc_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">CompressiveTransformerLayer</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mem</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-56'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-56'>#</a>
                </div>
                <p>토큰 임베딩과 메모리를 분리합니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">311</span>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="lineno">312</span>        <span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-57'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-57'>#</a>
                </div>
                <p> <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:1.16678em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqe" style=""><span class="mord" style=""><span
                                                class="mord" style=""><span class="mord coloredeq eqj" style=""><span
                                                        class="mord mathnormal"
                                                        style="margin-right:0.10764em">f</span><span
                                                        class="msupsub"><span class="vlist-t vlist-t2"><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.151392em;"><span
                                                                        style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                            class="pstrut"
                                                                            style="height:2.7em;"></span><span
                                                                            class="sizing reset-size6 size3 mtight"
                                                                            style=""><span class="mord mtight"
                                                                                style=""><span
                                                                                    class="mord mathnormal mtight coloredeq eqk"
                                                                                    style="">c</span></span></span></span></span><span
                                                                    class="vlist-s">​</span></span><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.15em;"><span></span></span></span></span></span></span></span><span
                                                class="msupsub"><span class="vlist-t"><span class="vlist-r"><span
                                                            class="vlist" style="height:0.97234em;"><span
                                                                style="top:-3.14734em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mopen mtight" style="">(</span><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eql"
                                                                                style="">i</span></span><span
                                                                            class="mclose mtight"
                                                                            style="">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span>함수로
                    메모리를 압축합니다.
                    <span><span class="katex"><span aria-hidden="true" class="katex-html"><span class="base"><span
                                        class="strut" style="height:1.16678em;vertical-align:-0.19444em;"></span><span
                                        class="mord coloredeq eqe" style=""><span class="mord" style=""><span
                                                class="mord" style=""><span class="mord coloredeq eqj" style=""><span
                                                        class="mord mathnormal"
                                                        style="margin-right:0.10764em">f</span><span
                                                        class="msupsub"><span class="vlist-t vlist-t2"><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.151392em;"><span
                                                                        style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span
                                                                            class="pstrut"
                                                                            style="height:2.7em;"></span><span
                                                                            class="sizing reset-size6 size3 mtight"
                                                                            style=""><span class="mord mtight"
                                                                                style=""><span
                                                                                    class="mord mathnormal mtight coloredeq eqk"
                                                                                    style="">c</span></span></span></span></span><span
                                                                    class="vlist-s">​</span></span><span
                                                                class="vlist-r"><span class="vlist"
                                                                    style="height:0.15em;"><span></span></span></span></span></span></span></span><span
                                                class="msupsub"><span class="vlist-t"><span class="vlist-r"><span
                                                            class="vlist" style="height:0.97234em;"><span
                                                                style="top:-3.14734em;margin-right:0.05em;"><span
                                                                    class="pstrut" style="height:2.7em;"></span><span
                                                                    class="sizing reset-size6 size3 mtight"
                                                                    style=""><span class="mord mtight" style=""><span
                                                                            class="mopen mtight" style="">(</span><span
                                                                            class="mord mtight" style=""><span
                                                                                class="mord mathnormal mtight coloredeq eql"
                                                                                style="">i</span></span><span
                                                                            class="mclose mtight"
                                                                            style="">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span>
                    의 매개변수들은 그래디언트 계산으로부터 분리되지 않은 매개변수들입니다.
                </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">316</span>        <span class="n">c_mem</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-58'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-58'>#</a>
                </div>
                <p>임베딩과 메모리를 정규화합니다. </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">319</span>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">norm_self_attn</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="lineno">320</span>        <span class="n">mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">norm_self_attn</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span>
<span class="lineno">321</span>        <span class="n">c_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">norm_self_attn</span><span class="p">,</span> <span class="n">c_mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-59'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-59'>#</a>
                </div>
                <p>압축되지 않은 메모리의 어텐션을 계산합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">324</span>        <span class="n">attn_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-60'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-60'>#</a>
                </div>
                <p>압축된 메모리의 어텐션을 계산합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">326</span>        <span class="n">attn_cmem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c_mem</span><span class="p">,</span> <span class="n">c_mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-61'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-61'>#</a>
                </div>
                <p>평균 제곱 오차를 계산합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">329</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">attn_cmem</span><span class="p">,</span> <span class="n">attn_mem</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-62'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-62'>#</a>
                </div>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">331</span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">mem</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-63'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-63'>#</a>
                </div>
                <p>각 레이어의 손실들을 계산합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">333</span>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_loss</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)]</span></pre>
                </div>
            </div>
        </div>
        <div class='section' id='section-64'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-64'>#</a>
                </div>
                <p>손실들의 합을 계산합니다 </p>

            </div>
            <div class='code'>
                <div class="highlight">
                    <pre><span class="lineno">335</span>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span></pre>
                </div>
            </div>
        </div>
        <div class='footer'>
            <a href="https://papers.labml.ai">Trending Research Papers</a>
            <a href="https://labml.ai">labml.ai</a>
        </div>
    </div>
    <script src=../../interactive.js?v=1"></script>
    <script>
        function handleImages() {
            var images = document.querySelectorAll('p>img')

            for (var i = 0; i < images.length; ++i) {
                handleImage(images[i])
            }
        }

        function handleImage(img) {
            img.parentElement.style.textAlign = 'center'

            var modal = document.createElement('div')
            modal.id = 'modal'

            var modalContent = document.createElement('div')
            modal.appendChild(modalContent)

            var modalImage = document.createElement('img')
            modalContent.appendChild(modalImage)

            var span = document.createElement('span')
            span.classList.add('close')
            span.textContent = 'x'
            modal.appendChild(span)

            img.onclick = function () {
                console.log('clicked')
                document.body.appendChild(modal)
                modalImage.src = img.src
            }

            span.onclick = function () {
                document.body.removeChild(modal)
            }
        }

        handleImages()
    </script>
</body>

</html>